<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>全球地理資訊系統</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        body, html { margin: 0; padding: 0; height: 100%; background: #001529; overflow: hidden; font-family: sans-serif; }
        #map { height: 100vh; width: 100%; }
        /* 介紹視窗的樣式 */
        .custom-popup .leaflet-popup-content-wrapper {
            background: rgba(255, 255, 255, 0.95);
            color: #333;
            padding: 10px;
            border-radius: 8px;
        }
        .flag-img { width: 100px; display: block; margin-bottom: 10px; border: 1px solid #ddd; }
        .wiki-link { color: #3498db; text-decoration: none; font-weight: bold; }
    </style>
</head>
<body>

    <div id="map"></div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        // 1. 初始化地圖：設定限制，防止地圖重複跑出來
        const map = L.map('map', {
            center: [20, 0],
            zoom: 2,
            maxBounds: [[-90, -180], [90, 180]], // 限制範圍，地圖就不會重複
            maxBoundsViscosity: 1.0
        });

        // 2. 使用 OpenStreetMap 標準底圖（這張最穩定，保證不會黑掉）
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);

        // 3. 翻譯對照表 (確保跳轉維基百科不會 Undefined)
        const countryTranslation = {
            "Taiwan": "臺灣", "Japan": "日本", "China": "中國", "USA": "美國", 
            "United States of America": "美國", "France": "法國", "Germany": "德國", 
            "South Korea": "韓國", "United Kingdom": "英國", "Russia": "俄羅斯", "Italy": "義大利"
        };

        // 4. 載入國界
        fetch('https://raw.githubusercontent.com/datasets/geo-countries/master/data/countries.geojson')
            .then(res => res.json())
            .then(data => {
                L.geoJSON(data, {
                    style: { color: "#2c3e50", weight: 1, fillOpacity: 0.1 },
                    onEachFeature: function (feature, layer) {
                        const engName = feature.properties.ADMIN;
                        const zhName = countryTranslation[engName] || engName;

                        layer.on('mouseover', function() { this.setStyle({ fillOpacity: 0.4, fillColor: "#3498db" }); });
                        layer.on('mouseout', function() { this.setStyle({ fillOpacity: 0.1 }); });

                        // 點擊後直接在地上顯示「介紹內容」
                        layer.on('click', async function(e) {
                            const popup = L.popup({ className: 'custom-popup' })
                                .setLatLng(e.latlng)
                                .setContent(`<b>正在讀取 ${zhName} 的詳細資訊...</b>`)
                                .openOn(map);

                            try {
                                // 抓取國旗與介紹
                                const [cRes, wRes] = await Promise.all([
                                    fetch(`https://restcountries.com/v3.1/name/${engName}?fullText=true`),
                                    fetch(`https://zh.wikipedia.org/api/rest_v1/page/summary/${encodeURIComponent(zhName)}`)
                                ]);
                                
                                const country = (await cRes.json())[0];
                                const wiki = await wRes.json();

                                popup.setContent(`
                                    <img src="${country.flags.png}" class="flag-img">
                                    <h3 style="margin:0">${zhName}</h3>
                                    <p><b>首都：</b>${country.capital[0]}</p>
                                    <p><b>人口：</b>${country.population.toLocaleString()}</p>
                                    <p style="font-size:12px; color:666;">${wiki.extract || '暫無詳細內容'}</p>
                                    <a href="https://zh.wikipedia.org/wiki/${encodeURIComponent(zhName)}" target="_blank" class="wiki-link">查看更多介紹 →</a>
                                `);
                            } catch (err) {
                                popup.setContent(`<b>${zhName}</b><br>點擊下方連結看介紹：<br><a href="https://zh.wikipedia.org/wiki/${encodeURIComponent(zhName)}" target="_blank">維基百科</a>`);
                            }
                        });
                    }
                }).addTo(map);
            });
    </script>
</body>
</html>
